name: Build EWDK Toolkit on Linux

on:
  push:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # 每周一UTC0点运行

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 增加超时时间

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Go环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: 安装基础依赖
        run: |
          sudo apt update
          sudo apt install -y zstd fuseiso p7zip-full git build-essential

      - name: 安装最新版 zstd
        run: |
          # 安装最新版 zstd 支持高压缩级别
          git clone https://github.com/facebook/zstd.git /tmp/zstd
          cd /tmp/zstd
          make -j$(nproc)
          sudo make install
          sudo ldconfig  # 更新共享库缓存

      - name: 获取并设置EWDK URL
        id: set-url
        run: go run scripts/get_ewdk_url.go

      - name: 下载ISO
        run: |
          echo "✅ 下载URL: ${{ env.EWDK_ISO_URL }}"
          curl -L -o /tmp/ewdk.iso "${{ env.EWDK_ISO_URL }}" \
            --retry 5 --retry-delay 3 --max-time 600
          
          # 验证下载文件
          FILE_SIZE=$(stat -c%s /tmp/ewdk.iso)
          if [ $FILE_SIZE -lt 500000000 ]; then
            echo "❌ 错误: 文件太小 (仅 $((FILE_SIZE/1000000)) MB)"
            exit 1
          fi
          echo "✔️ ISO下载完成 ($((FILE_SIZE/1000000)) MB)"
          echo "iso_path=/tmp/ewdk.iso" >> $GITHUB_ENV

      - name: 挂载ISO
        run: |
          sudo mkdir -p /mnt/ewdk
          sudo mount -o loop /tmp/ewdk.iso /mnt/ewdk
          echo "✅ ISO挂载完成"

      - name: 安装Go模块
        run: |
          go env -w GOPROXY=https://goproxy.cn,direct
          go mod tidy

      - name: 运行提取程序
        timeout-minutes: 30
        run: |
          # 清理旧目录
          if [ -d "ewdk" ]; then
            rm -rf ewdk
          fi
          
          # 运行提取程序
          go run .
          
          # 验证提取结果
          if [ ! -d "ewdk" ]; then
            echo "❌ 错误: 提取程序未创建ewdk目录"
            exit 1
          fi
          FILE_COUNT=$(find ewdk -type f | wc -l)
          echo "✅ 提取完成: $FILE_COUNT 个文件"

      - name: 创建压缩包
        run: |
          # 压缩目录 (使用最新版zstd)
          tar cf - ewdk | zstd --ultra -22 -T0 -o /tmp/ewdk.tar.zst
          
          # 验证压缩包
          ARCHIVE_SIZE=$(stat -c%s /tmp/ewdk.tar.zst)
          if [ $ARCHIVE_SIZE -lt 100000000 ]; then
            echo "❌ 错误: 压缩包太小 (仅 $((ARCHIVE_SIZE/1000000)) MB)"
            exit 1
          fi
          echo "✔️ 压缩完成: $((ARCHIVE_SIZE/1000000)) MB"
          echo "archive_path=/tmp/ewdk.tar.zst" >> $GITHUB_ENV

      - name: 上传成品
        uses: actions/upload-artifact@v4
        with:
          name: ewdk.tar.zst
          path: ${{ env.archive_path }}
          retention-days: 7
          compression-level: 0  # 避免GitHub二次压缩

      - name: 上传log
        uses: actions/upload-artifact@v4
        with:
          name: log.log
          path: log.log
          retention-days: 7
          compression-level: 0  # 避免GitHub二次压缩

      - name: 清理资源
        run: |
          # 卸载ISO
          sudo umount /mnt/ewdk || true
          
          # 删除临时文件
          sudo rm -rf /mnt/ewdk
          rm -f /tmp/ewdk.iso
          rm -f /tmp/ewdk.tar.zst
          sudo rm -rf /tmp/zstd