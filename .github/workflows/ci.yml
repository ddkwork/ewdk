name: Build EWDK Toolkit on Linux

on:
  push:
    branches: [master]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # 每周一UTC0点运行

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Go环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: 安装基础依赖
        run: |
          sudo apt update
          sudo apt install -y zstd fuseiso p7zip-full

      - name: 获取EWDK URL
        id: get-url
        run: |
          URL=$(go run scripts/get_ewdk_url.go)
          echo "✅ 下载URL: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: 下载ISO
        run: |
          curl -L -o /tmp/ewdk.iso "${{ steps.get-url.outputs.url }}" \
            --retry 5 --retry-delay 3
          echo "iso_path=/tmp/ewdk.iso" >> $GITHUB_ENV

      - name: 挂载ISO
        run: |
          sudo mkdir -p /mnt/ewdk
          sudo mount -o loop /tmp/ewdk.iso /mnt/ewdk

      - name: 安装Go模块
        run: go get -u github.com/ddkwork/golibrary

      - name: 运行提取程序
        run: |
          if [ -d "ewdk" ]; then
            rm -rf ewdk
          fi
          go run ./extract_ewdk.go

      - name: 创建压缩包
        run: |
          tar cf - ewdk | zstd -22 -T0 -o /tmp/ewdk.tar.zst
          echo "archive_path=/tmp/ewdk.tar.zst" >> $GITHUB_ENV

      - name: 上传成品
        uses: actions/upload-artifact@v4
        with:
          name: ewdk-toolkit-linux
          path: ${{ env.archive_path }}
          retention-days: 7

      - name: 清理资源
        run: |
          sudo umount /mnt/ewdk || true
          sudo rm -rf /mnt/ewdk
          rm -f /tmp/ewdk.iso
          rm -f /tmp/ewdk.tar.zst