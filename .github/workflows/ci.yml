name: Build EWDK Toolkit on Linux

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ UTC æ—¶é—´ 0 ç‚¹è¿è¡Œ

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd wimtools fuseiso p7zip-full
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          mkdir -p /tmp/ewdk_workdir

      # 2. è·å– EWDK ä¸‹è½½ URL
      - name: Get EWDK URL
        id: get_ewdk_url
        run: |
          # ä½¿ç”¨ curl è·å–é‡å®šå‘é“¾æ¥
          ISO_URL=$(curl -s -I -o /dev/null -w "%{redirect_url}" "https://aka.ms/ewdk")
          if [[ "$ISO_URL" != *.iso ]]; then
            echo "âŒ é”™è¯¯: æ— æ•ˆçš„ EWDK URL: $ISO_URL"
            exit 1
          fi
          echo "final_url=$ISO_URL" >> $GITHUB_OUTPUT

      # 3. ä¸‹è½½ ISO åˆ°ä¸´æ—¶ç›®å½•
      - name: Download ISO
        run: |
          ISO_PATH="/tmp/ewdk_temp.iso"
          echo "ğŸ“¥ ä¸‹è½½ EWDK ISO åˆ°: $ISO_PATH"
          curl -L -o "$ISO_PATH" "${{ steps.get_ewdk_url.outputs.final_url }}" \
               --retry 5 --retry-delay 10 --retry-max-time 300
          
          # éªŒè¯ä¸‹è½½å®Œæ•´æ€§ (è‡³å°‘ 500MB)
          FILE_SIZE=$(stat -c%s "$ISO_PATH")
          if [ "$FILE_SIZE" -lt 500000000 ]; then
            echo "âŒ ä¸‹è½½æ–‡ä»¶è¿‡å°: $((FILE_SIZE/1000000)) MB"
            exit 1
          fi
          echo "âœ”ï¸ ISO ä¸‹è½½å®Œæˆ ($((FILE_SIZE/1000000)) MB)"
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV

      # 4. æŒ‚è½½ ISO (ä½¿ç”¨ Linux è™šæ‹Ÿå…‰é©±)
      - name: Mount ISO
        run: |
          MOUNT_POINT=$(mktemp -d)
          sudo mount -o loop,ro "$ISO_PATH" "$MOUNT_POINT"
          echo "MOUNT_POINT=$MOUNT_POINT" >> $GITHUB_ENV
          echo "ğŸ’¿ ISO æŒ‚è½½åˆ°: $MOUNT_POINT"

      # 5. è¿è¡Œ Go æå–ç¨‹åº
      - name: Run extraction
        run: |
          # æ¸…ç†æ—§ ewdk ç›®å½•
          if [ -d "$GITHUB_WORKSPACE/ewdk" ]; then
            echo "ğŸ§¹ æ¸…ç†å­˜åœ¨çš„ ewdk ç›®å½•..."
            rm -rf "$GITHUB_WORKSPACE/ewdk"
          fi
          
          echo "ğŸš€ è¿è¡Œ Go æå–ç¨‹åº..."
          go run ./extract_ewdk.go -source "$MOUNT_POINT" -dest "$GITHUB_WORKSPACE/ewdk"
          
          # éªŒè¯æå–ç»“æœ
          FILE_COUNT=$(find "$GITHUB_WORKSPACE/ewdk" -type f | wc -l)
          if [ "$FILE_COUNT" -lt 100 ]; then
            echo "âŒ æå–æ–‡ä»¶æ•°é‡è¿‡å°‘: $FILE_COUNT"
            exit 1
          fi
          echo "âœ”ï¸ æå–äº† $FILE_COUNT ä¸ªæ–‡ä»¶åˆ° $GITHUB_WORKSPACE/ewdk"

      # 6. å¸è½½å¹¶åˆ é™¤ ISO
      - name: Unmount and cleanup ISO
        run: |
          # ç¡®ä¿å¸è½½
          sudo umount -f "$MOUNT_POINT" || true
          sudo rm -rf "$MOUNT_POINT"
          
          # åˆ é™¤ ISO æ–‡ä»¶
          if [ -f "$ISO_PATH" ]; then
            rm -f "$ISO_PATH"
            echo "ğŸ—‘ï¸ å·²åˆ é™¤ ISO æ–‡ä»¶"
          fi

      # 7. å‹ç¼©ä¸º .tar.zst
      - name: Compress to .tar.zst
        run: |
          # å®‰è£…æœ€æ–° zstd ç‰ˆæœ¬
          sudo apt-get update
          sudo apt-get install -y build-essential
          git clone https://github.com/facebook/zstd.git /tmp/zstd
          (cd /tmp/zstd && make -j$(nproc) && sudo make install)
          
          # å‹ç¼© ewdk ç›®å½•
          ARCHIVE_PATH="/tmp/ewdk.tar.zst"
          echo "ğŸ“¦ å‹ç¼© ewdk ç›®å½•åˆ° $ARCHIVE_PATH..."
          
          # ä½¿ç”¨å¤šçº¿ç¨‹æœ€é«˜å‹ç¼©çº§åˆ«
          tar -cf - -C "$GITHUB_WORKSPACE" ewdk | zstd --ultra -22 -T0 -o "$ARCHIVE_PATH"
          
          # éªŒè¯å‹ç¼©æ–‡ä»¶
          ARCHIVE_SIZE=$(stat -c%s "$ARCHIVE_PATH")
          echo "âœ”ï¸ å‹ç¼©å®Œæˆ - å¤§å°: $((ARCHIVE_SIZE/1000000)) MB"
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

      # 8. ä¸Šä¼ å‹ç¼©åŒ…ä¸º Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ewdk-toolkit-linux
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 7
          compression-level: 0  # ä¸è¿›è¡Œé¢å¤–å‹ç¼©

      # 9. æ¸…ç†å·¥ä½œåŒºï¼ˆå¯é€‰ï¼‰
      - name: Cleanup workspace
        if: ${{ always() }}
        run: |
          # åˆ é™¤å‹ç¼©åŒ…
          if [ -f "$ARCHIVE_PATH" ]; then
            rm -f "$ARCHIVE_PATH"
          fi
          
          # ä¿ç•™ ewdk ç›®å½•å¯é€‰
          # echo "å¦‚éœ€ä¿ç•™ ewdk ç›®å½•ï¼Œè¯·ç§»é™¤æ­¤æ­¥éª¤"
          # rm -rf "$GITHUB_WORKSPACE/ewdk"
