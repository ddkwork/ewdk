name: Build EWDK Toolkit on Linux

on:
  push:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y zstd fuseiso p7zip-full git build-essential aria2

      - name: è·å–å¹¶è®¾ç½®EWDK URL
        id: set-url
        run: |
          EWDK_URL=$(go run scripts/get_ewdk_url.go)
          echo "EWDK_ISO_URL=$EWDK_URL" >> $GITHUB_ENV
          echo "âœ… ä¸‹è½½URLè®¾ç½®å®Œæˆ: $EWDK_URL"

      # ä¼˜åŒ–çš„ç½‘ç»œè¯Šæ–­å’Œç¨³å®šä¸‹è½½æ–¹æ¡ˆ
      - name: ç¨³å®šä¸‹è½½ISO
        run: |
          # å¯é çš„é€Ÿåº¦è¯Šæ–­
          echo "ğŸ“¶ ç½‘ç»œè´¨é‡è¯Šæ–­..."
          curl -Lo /dev/null -skw """
              ä¸‹è½½é€Ÿåº¦: %{speed_download} bps
              è¿æ¥æ—¶é—´: %{time_connect}ç§’
              ä¼ è¾“æ—¶é—´: %{time_total}ç§’\n
              """ ${{ env.EWDK_ISO_URL }} > /tmp/speedtest.txt 2>&1
          cat /tmp/speedtest.txt
          
          # è‡ªé€‚åº”ä¸‹è½½ç­–ç•¥
          MAX_CONN=16
          MIN_SPEED=$((10*1024*1024))  # 10MB/s
          if grep -q "ä¸‹è½½é€Ÿåº¦: [0-9]." /tmp/speedtest.txt; then
            SPEED=$(grep "ä¸‹è½½é€Ÿåº¦" /tmp/speedtest.txt | awk '{print $2}')
            if [ $SPEED -lt $MIN_SPEED ]; then
              MAX_CONN=32
              echo "âš ï¸ ç½‘ç»œè¾ƒæ…¢ ($((SPEED/1024/1024))MB/s)ï¼Œå¯ç”¨åŠ é€Ÿæ¨¡å¼ (32çº¿ç¨‹)"
            else
              echo "âš¡ ç½‘ç»œè‰¯å¥½ ($((SPEED/1024/1024))MB/s)ï¼Œä½¿ç”¨æ ‡å‡†æ¨¡å¼"
            fi
          fi
          
          # ç¨³å®šä¸‹è½½å‘½ä»¤
          aria2c --summary-interval=30 \
            -x $MAX_CONN -s 8 -k 2M -c "${{ env.EWDK_ISO_URL }}" \
            -d /tmp -o ewdk.iso \
            --file-allocation=falloc \
            --retry-wait=3 \
            --max-tries=10 \
            --timeout=900 \
            --check-certificate=false
          
          # éªŒè¯ä¸‹è½½æ–‡ä»¶
          FILE_SIZE=$(stat -c%s /tmp/ewdk.iso)
          echo "ğŸ“¦ ä¸‹è½½å¤§å°: $((FILE_SIZE/1024/1024))MB"
          [ $FILE_SIZE -gt 500000000 ] || (echo "âŒ æ–‡ä»¶å¤ªå°"; exit 1)

      # ä»¥ä¸‹æ­¥éª¤ä¿æŒä¸å˜...
      - name: æŒ‚è½½ISO
        run: |
          sudo mkdir -p /mnt/ewdk
          sudo mount -o loop /tmp/ewdk.iso /mnt/ewdk
          
      - name: å®‰è£…Goæ¨¡å—
        run: go mod tidy
          
      - name: è¿è¡Œæå–ç¨‹åº
        timeout-minutes: 30
        run: go run .
        
      - name: åˆ›å»ºwdkå‹ç¼©åŒ…
        run: |
          tar cf - dist/wdk | zstd --ultra -22 -T0 -o /tmp/wdk.tar.zst
          echo "wdk_path=/tmp/wdk.tar.zst" >> $GITHUB_ENV
          
      - name: ä¸Šä¼ wdkæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: wdk.tar.zst
          path: ${{ env.wdk_path }}
          
      - name: åˆ›å»ºsdkå‹ç¼©åŒ…
        run: |
          tar cf - dist/sdk | zstd --ultra -22 -T0 -o /tmp/sdk.tar.zst
          echo "sdk_path=/tmp/sdk.tar.zst" >> $GITHUB_ENV
          
      - name: ä¸Šä¼ sdkæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: sdk.tar.zst
          path: ${{ env.sdk_path }}
          
      - name: æ¸…ç†èµ„æº
        run: |
          sudo umount /mnt/ewdk || true
          sudo rm -rf /mnt/ewdk /tmp/ewdk.iso /tmp/*.tar.zst
