name: Build EWDK Toolkit on Linux

on:
  push:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y zstd fuseiso p7zip-full git build-essential aria2
          
          # æ™ºèƒ½æ£€æŸ¥ZSTDç‰ˆæœ¬
          ZSTD_VERSION=$(zstd --version | head -1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+')
          echo "â„¹ï¸ ç³»ç»Ÿ ZSTD ç‰ˆæœ¬: $ZSTD_VERSION"
          
          # ä»…å½“ç‰ˆæœ¬ä½äº1.4.2æ—¶æ‰å®‰è£…æ–°ç‰ˆ
          if [[ "$(echo $ZSTD_VERSION | sed 's/v//;s/\.//g')" -lt "10402" ]]; then
            echo "ğŸ”„ å®‰è£…æ–°ç‰ˆ ZSTDï¼ˆå½“å‰ç‰ˆæœ¬è¾ƒä½ï¼‰"
            git clone https://github.com/facebook/zstd.git /tmp/zstd
            cd /tmp/zstd
            make -j$(nproc)
            sudo make install
            sudo ldconfig
          else
            echo "âœ… ç³»ç»Ÿ ZSTD ç‰ˆæœ¬è¶³å¤Ÿæ–°ï¼Œè·³è¿‡ç¼–è¯‘å®‰è£…"
          fi

      - name: è·å–å¹¶è®¾ç½®EWDK URL
        id: set-url
        run: go run scripts/get_ewdk_url.go

      - name: ä¸‹è½½ISO
        run: |
          # æ¸…ç†URLä¸­çš„ä¸å¯è§å­—ç¬¦
          CLEAN_URL=$(echo "${{ env.EWDK_ISO_URL }}" | tr -d '[:space:]')
          echo "âœ… æ¸…ç†åä¸‹è½½URL: $CLEAN_URL"
          
          # å®‰å…¨ä¸‹è½½å‘½ä»¤
          aria2c \
            -x 16 -s 64 -k 4M \
            -j 16 \
            -c "$CLEAN_URL" \
            -d /tmp -o ewdk.iso \
            --file-allocation=prealloc \
            --retry-wait=1 \
            --max-tries=3 \
            --min-split-size=10M \
            --log=/tmp/aria2.log \
            --summary-interval=1 \
            --check-certificate=false  # é¿å…SSLé—®é¢˜
          
          # éªŒè¯ä¸‹è½½æ–‡ä»¶
          FILE_SIZE=$(stat -c%s /tmp/ewdk.iso)
          if [ $FILE_SIZE -lt 500000000 ]; then
            echo "âŒ é”™è¯¯: æ–‡ä»¶å¤ªå° (ä»… $((FILE_SIZE/1000000)) MB)"
            exit 1
          fi
          
          # è®¡ç®—å®é™…ä¸‹è½½é€Ÿåº¦
          if [ -f /tmp/aria2.log ]; then
            AVG_SPEED=$(grep 'Download Results' -A 2 /tmp/aria2.log | awk '/MiB\/s/ {print $3}')
            echo "âš¡ å¹³å‡ä¸‹è½½é€Ÿåº¦: $AVG_SPEED MiB/s"
          fi
          
          echo "âœ”ï¸ ISOä¸‹è½½å®Œæˆ ($((FILE_SIZE/1000000)) MB)"
          echo "iso_path=/tmp/ewdk.iso" >> $GITHUB_ENV
          
          # ç«‹å³æ¸…é™¤ä¸‹è½½URLç¯å¢ƒå˜é‡
          echo "EWDK_ISO_URL=" >> $GITHUB_ENV
          echo "âœ… å·²æ¸…é™¤ä¸‹è½½URLç¯å¢ƒå˜é‡"

      - name: æŒ‚è½½ISO
        run: |
          sudo mkdir -p /mnt/ewdk
          sudo mount -o loop /tmp/ewdk.iso /mnt/ewdk
          echo "âœ… ISOæŒ‚è½½å®Œæˆ"

      - name: å®‰è£…Goæ¨¡å—
        run: |
          go mod tidy

      - name: è¿è¡Œæå–ç¨‹åº
        timeout-minutes: 30
        run: |
          go run .

      - name: åˆ›å»ºwdkå‹ç¼©åŒ…
        run: |
          # ä½¿ç”¨æ™ºèƒ½é€‰æ‹©çš„å‹ç¼©çº§åˆ«
          if zstd -22 -T0 -h >/dev/null 2>&1; then
            COMPRESS_LEVEL="--ultra -22"
          else
            COMPRESS_LEVEL="-19"
          fi
          echo "â„¹ï¸ ä½¿ç”¨å‹ç¼©çº§åˆ«: $COMPRESS_LEVEL"
          
          tar cf - dist/wdk | zstd $COMPRESS_LEVEL -T0 -o /tmp/wdk.tar.zst
          
          ARCHIVE_SIZE=$(stat -c%s /tmp/wdk.tar.zst)
          echo "âœ”ï¸ å‹ç¼©å®Œæˆ: $((ARCHIVE_SIZE/1000000)) MB"
          echo "wdk_path=/tmp/wdk.tar.zst" >> $GITHUB_ENV

      - name: ä¸Šä¼ wdkæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: wdk.tar.zst
          path: ${{ env.wdk_path }}
          retention-days: 7
          compression-level: 0

      - name: åˆ›å»ºsdkå‹ç¼©åŒ…
        run: |
          # ä½¿ç”¨æ™ºèƒ½é€‰æ‹©çš„å‹ç¼©çº§åˆ«
          if zstd -22 -T0 -h >/dev/null 2>&1; then
            COMPRESS_LEVEL="--ultra -22"
          else
            COMPRESS_LEVEL="-19"
          fi
          echo "â„¹ï¸ ä½¿ç”¨å‹ç¼©çº§åˆ«: $COMPRESS_LEVEL"
          
          tar cf - dist/sdk | zstd $COMPRESS_LEVEL -T0 -o /tmp/sdk.tar.zst
          
          ARCHIVE_SIZE=$(stat -c%s /tmp/sdk.tar.zst)
          if [ $ARCHIVE_SIZE -lt 100000000 ]; then
            echo "âŒ é”™è¯¯: å‹ç¼©åŒ…å¤ªå° (ä»… $((ARCHIVE_SIZE/1000000)) MB)"
            exit 1
          fi
          echo "âœ”ï¸ å‹ç¼©å®Œæˆ: $((ARCHIVE_SIZE/1000000)) MB"
          echo "sdk_path=/tmp/sdk.tar.zst" >> $GITHUB_ENV

      - name: ä¸Šä¼ sdkæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: sdk.tar.zst
          path: ${{ env.sdk_path }}
          retention-days: 7
          compression-level: 0

      - name: æ¸…ç†èµ„æº
        run: |
          sudo umount /mnt/ewdk || true
          sudo rm -rf /mnt/ewdk
          rm -f /tmp/ewdk.iso
          rm -f /tmp/wdk.tar.zst
          rm -f /tmp/sdk.tar.zst
          sudo rm -rf /tmp/zstd
          rm -f /tmp/aria2.log
