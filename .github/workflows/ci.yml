name: Build EWDK Toolkit on Linux

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ UTC æ—¶é—´ 0 ç‚¹è¿è¡Œ

jobs:
  build-ewdk:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0-rc.1'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd wimtools fuseiso p7zip-full
          mkdir -p /tmp/ewdk_workdir

      # 2. ä½¿ç”¨ Go è„šæœ¬è·å–æ­£ç¡®çš„ EWDK URL
      - name: Get EWDK URL
        id: get_ewdk_url
        run: |
          cat <<EOF > extract_url.go
          package main

          import (
              "fmt"
              "net/http"
              "strings"
              "os"
          )

          func main() {
              resp, err := http.Get("https://learn.microsoft.com/en-us/legal/windows/hardware/enterprise-wdk-license-2022")
              if err != nil {
                  fmt.Fprintf(os.Stderr, "âŒ HTTPè¯·æ±‚å¤±è´¥: %v\n", err)
                  os.Exit(1)
              }
              defer resp.Body.Close()

              buf := new(strings.Builder)
              buf.ReadFrom(resp.Body)

              var latestEWDK string
              for _, s := range strings.Split(buf.String(), "\n") {
                  if strings.Contains(s, "Accept license terms") {
                      if _, after, found := strings.Cut(s, `href="`); found {
                          if before, _, found := strings.Cut(after, `"`); found {
                              latestEWDK = before
                              break
                          }
                      }
                  }
              }

              if latestEWDK == "" {
                  fmt.Fprintln(os.Stderr, "âŒ é”™è¯¯: æ— æ³•ä»é¡µé¢è§£æä¸‹è½½URL")
                  os.Exit(1)
              }

              fmt.Println(latestEWDK)
          }
          EOF

          echo "ğŸ› ï¸ ç¼–è¯‘å¹¶è¿è¡Œ URL æå–è„šæœ¬..."
          go build -o extract_url extract_url.go
          URL=$(./extract_url)
          echo "æå–åˆ°çš„ä¸‹è½½URL: $URL"
          echo "final_url=$URL" >> $GITHUB_OUTPUT
          rm -f extract_url extract_url.go

      # 3. ä¸‹è½½ ISO åˆ°ä¸´æ—¶ç›®å½•
      - name: Download ISO
        run: |
          ISO_PATH="/tmp/ewdk_temp.iso"
          echo "ğŸ“¥ ä¸‹è½½ EWDK ISO åˆ°: $ISO_PATH"
          echo "ä½¿ç”¨URL: ${{ steps.get_ewdk_url.outputs.final_url }}"
          
          curl -L -o "$ISO_PATH" "${{ steps.get_ewdk_url.outputs.final_url }}" \
               --retry 5 --retry-delay 10 --retry-max-time 300
          
          # éªŒè¯ä¸‹è½½å®Œæ•´æ€§ (è‡³å°‘ 500MB)
          FILE_SIZE=$(stat -c%s "$ISO_PATH")
          if [ "$FILE_SIZE" -lt 500000000 ]; then
            echo "âŒ ä¸‹è½½æ–‡ä»¶è¿‡å°: $((FILE_SIZE/1000000)) MB"
            exit 1
          fi
          echo "âœ”ï¸ ISO ä¸‹è½½å®Œæˆ ($((FILE_SIZE/1000000)) MB)"
          echo "ISO_PATH=$ISO_PATH" >> $GITHUB_ENV

      # ... ä»¥ä¸‹æ­¥éª¤ä¿æŒä¸å˜ ...
      # 4. æŒ‚è½½ ISO (ä½¿ç”¨ Linux è™šæ‹Ÿå…‰é©±)
      - name: Mount ISO
        run: |
          MOUNT_POINT=$(mktemp -d)
          sudo mount -o loop,ro "$ISO_PATH" "$MOUNT_POINT"
          echo "MOUNT_POINT=$MOUNT_POINT" >> $GITHUB_ENV
          echo "ğŸ’¿ ISO æŒ‚è½½åˆ°: $MOUNT_POINT"

      # 5. è¿è¡Œ Go æå–ç¨‹åº
      - name: Run extraction
        run: |
          # æ¸…ç†æ—§ ewdk ç›®å½•
          if [ -d "$GITHUB_WORKSPACE/ewdk" ]; then
            echo "ğŸ§¹ æ¸…ç†å­˜åœ¨çš„ ewdk ç›®å½•..."
            rm -rf "$GITHUB_WORKSPACE/ewdk"
          fi
          
          echo "ğŸš€ è¿è¡Œ Go æå–ç¨‹åº..."
          go run ./extract_ewdk.go -source "$MOUNT_POINT" -dest "$GITHUB_WORKSPACE/ewdk"
          
          # éªŒè¯æå–ç»“æœ
          FILE_COUNT=$(find "$GITHUB_WORKSPACE/ewdk" -type f | wc -l)
          if [ "$FILE_COUNT" -lt 100 ]; then
            echo "âŒ æå–æ–‡ä»¶æ•°é‡è¿‡å°‘: $FILE_COUNT"
            exit 1
          fi
          echo "âœ”ï¸ æå–äº† $FILE_COUNT ä¸ªæ–‡ä»¶åˆ° $GITHUB_WORKSPACE/ewdk"

      # 6. å¸è½½å¹¶åˆ é™¤ ISO
      - name: Unmount and cleanup ISO
        run: |
          # ç¡®ä¿å¸è½½
          sudo umount -f "$MOUNT_POINT" || true
          sudo rm -rf "$MOUNT_POINT"
          
          # åˆ é™¤ ISO æ–‡ä»¶
          if [ -f "$ISO_PATH" ]; then
            rm -f "$ISO_PATH"
            echo "ğŸ—‘ï¸ å·²åˆ é™¤ ISO æ–‡ä»¶"
          fi

      # 7. å‹ç¼©ä¸º .tar.zst
      - name: Compress to .tar.zst
        run: |
          # å®‰è£…æœ€æ–° zstd ç‰ˆæœ¬
          sudo apt-get update
          sudo apt-get install -y build-essential
          git clone https://github.com/facebook/zstd.git /tmp/zstd
          (cd /tmp/zstd && make -j$(nproc) && sudo make install)
          
          # å‹ç¼© ewdk ç›®å½•
          ARCHIVE_PATH="/tmp/ewdk.tar.zst"
          echo "ğŸ“¦ å‹ç¼© ewdk ç›®å½•åˆ° $ARCHIVE_PATH..."
          
          # ä½¿ç”¨å¤šçº¿ç¨‹æœ€é«˜å‹ç¼©çº§åˆ«
          tar -cf - -C "$GITHUB_WORKSPACE" ewdk | zstd --ultra -22 -T0 -o "$ARCHIVE_PATH"
          
          # éªŒè¯å‹ç¼©æ–‡ä»¶
          ARCHIVE_SIZE=$(stat -c%s "$ARCHIVE_PATH")
          echo "âœ”ï¸ å‹ç¼©å®Œæˆ - å¤§å°: $((ARCHIVE_SIZE/1000000)) MB"
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

      # 8. ä¸Šä¼ å‹ç¼©åŒ…ä¸º Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ewdk-toolkit-linux
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 7
          compression-level: 0  # ä¸è¿›è¡Œé¢å¤–å‹ç¼©

      # 9. æ¸…ç†å·¥ä½œåŒºï¼ˆå¯é€‰ï¼‰
      - name: Cleanup workspace
        if: ${{ always() }}
        run: |
          # åˆ é™¤å‹ç¼©åŒ…
          if [ -f "$ARCHIVE_PATH" ]; then
            rm -f "$ARCHIVE_PATH"
          fi